<!DOCTYPE html>

<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>MBTI T/F ë¶„ì„ê¸° - ì§ˆë¬¸</title>
    <link rel="stylesheet" href="/static/common.css">
    <style>
        /* ëª¨ë˜ì‹œê³„ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€ */
        @keyframes rotate {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        .rotating-hourglass {
            padding: 0 0 5px 0;
            display: inline-block;
            animation: rotate 2s linear infinite;
            transform-origin: center center;
        }
        
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ë“¤... */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background: #f7f7f7;
        }
        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-image: url('./images/Bg1.png'); /* ì „ì²´ ë°°ê²½ ì´ë¯¸ì§€ */
            background-size: cover;
            background-position: center;
        }
        
        /* í™ˆ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #2196F3;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            font-size: 24px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .home-button:hover {
            background-color: #2196F3;
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .question-bar {
            width: 100vw;
            min-width: 100vw;
            max-width: 100vw;
            height: 150px;
            margin: 0 auto 0 auto;
            background: url('./images/textbar1.png') no-repeat center;
            background-size: cover;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            color: #111;
            text-align: center;
            box-sizing: border-box;
            border: none;
            box-shadow: none;
            background-color: transparent;
            padding: 0;
        }
        .character-center {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 350px;
            margin-bottom: 0;
            padding-bottom: 0;
            padding-top: 60px;
        }
        .character {
            width: 360px;
            height: 360px;
            margin: 0 auto 1.5rem auto;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .face {
            width: 360px;
            height: 360px;
            position: relative;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        .face-very-angry {
            background-image: url('/images/Very_angry.png');
        }
        .face-angry {
            background-image: url('/images/Simple_angry.png');
        }
        .face-neutral {
            background-image: url('/images/Base.png');
        }
        .face-happy {
            background-image: url('/images/Simple_happy.png');
        }
        .face-very-happy {
            background-image: url('/images/Very_happy.png');
        }
        #resultGraph {
            margin-top: 1.5rem;
            /* background-image: url('/static/images/report_bg.png'); */ /* ê²°ê³¼ ë¦¬í¬íŠ¸ ë°•ìŠ¤ ë°°ê²½ - íŒŒì¼ ì—†ìŒ */
            background-size: cover;
            background-position: center;
            border-radius: 20px;
            padding: 1.5rem;
        }
        .answer-bar {
            width: 100%;
            background: #fff;
            border-top: 2px solid #2196F3;
            padding: 0;
            display: flex;
            align-items: center;
            position: fixed;
            left: 0;
            bottom: 80px; /* í•˜ë‹¨ì—ì„œ 80px ìœ„ë¡œ ë„ì›€ */
            z-index: 10;
            box-shadow: 0 -2px 8px rgba(33,150,243,0.07);
            background-image: url('./images/textbar2.png'); /* í•˜ë‹¨ ì…ë ¥ ë°•ìŠ¤ ë°°ê²½ */
            background-size: auto;
            background-position: center;
            height: auto;
        }
        .answer-input {
            flex: 1 1 auto;
            padding: 1rem;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1rem;
            margin-right: 1rem;
        }
        .button-group {
            display: flex;
            flex-direction: row;
            gap: 0.7rem;
        }
        .submit-button, .stt-button, .enhanced-stt-button {
            padding: 0.8rem 1.5rem;
            font-size: 1rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .submit-button {
            background-color: #4CAF50;
            color: white;
        }
        .submit-button:hover {
            background-color: #45a049;
            transform: scale(1.05);
        }
        .stt-button {
            background-color: #E91E63;
            color: white;
        }
        .stt-button:hover {
            background-color: #C2185B;
            transform: scale(1.05);
        }
        .enhanced-stt-button {
            background-color: #FF9800;
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.8rem 1.2rem;
            min-width: 120px;
            justify-content: center;
            min-width: 50px;
            padding: 0.8rem;
        }
        .enhanced-stt-button:hover {
            background-color: #F57C00;
            transform: scale(1.05);
        }
        .enhanced-stt-button.active {
            background-color: #4CAF50;
        }
        .enhanced-stt-button.active:hover {
            background-color: #45a049;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ - ëª¨ë“  ë””ë°”ì´ìŠ¤ ìµœì í™” */
        
        /* ëª¨ë°”ì¼ ìµœì í™” */
        @media (max-width: 768px) {
            .character {
                width: 280px;
                height: 280px;
            }
            .face {
                width: 280px;
                height: 280px;
            }
            .question-bar {
                height: 120px;
                font-size: 1.1rem;
                padding: 0 1rem;
            }
            .answer-input {
                font-size: 1rem;
                padding: 0.8rem;
            }
            .submit-button, .stt-button {
                padding: 0.7rem 1.2rem;
                font-size: 0.9rem;
            }
            .home-button {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
        }
        
        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            .submit-button, .stt-button {
                min-height: 44px; /* iOS ê¶Œì¥ í„°ì¹˜ ì˜ì—­ */
            }
            .answer-input {
                min-height: 44px;
            }
        }
        
        /* ëŒ€í˜• ë°ìŠ¤í¬í†± (1200px ì´ìƒ) */
        @media (min-width: 1200px) {
            .question-bar {
                height: 180px;
                font-size: 1.5rem;
            }
            .character {
                width: 400px;
                height: 400px;
            }
            .face {
                width: 400px;
                height: 400px;
            }
            .uibox-bg {
                width: 900px;
                min-height: 180px;
            }
            .uibox-input {
                font-size: 1.3rem;
                height: 70px;
            }
        }
        
        /* ì¤‘í˜• ë°ìŠ¤í¬í†± (992px - 1199px) */
        @media (min-width: 992px) and (max-width: 1199px) {
            .question-bar {
                height: 160px;
                font-size: 1.4rem;
            }
            .character {
                width: 380px;
                height: 380px;
            }
            .face {
                width: 380px;
                height: 380px;
            }
            .uibox-bg {
                width: 850px;
                min-height: 160px;
            }
        }
        
        /* ì†Œí˜• ë°ìŠ¤í¬í†± (768px - 991px) */
        @media (min-width: 768px) and (max-width: 991px) {
            .question-bar {
                height: 150px;
                font-size: 1.3rem;
            }
            .character {
                width: 320px;
                height: 320px;
            }
            .face {
                width: 320px;
                height: 320px;
            }
            .uibox-bg {
                width: 700px;
                min-height: 150px;
                padding: 0 30px;
            }
            .uibox-input {
                font-size: 1.1rem;
                height: 60px;
            }
        }
        
        /* íƒœë¸”ë¦¿ (576px - 767px) */
        @media (min-width: 576px) and (max-width: 767px) {
            .question-bar {
                height: 140px;
                font-size: 1.2rem;
            }
            .character {
                width: 280px;
                height: 280px;
            }
            .face {
                width: 280px;
                height: 280px;
            }
            .uibox-bg {
                width: 90vw;
                min-height: 140px;
                padding: 0 25px;
                gap: 20px;
            }
            .uibox-input {
                font-size: 1rem;
                height: 55px;
                padding: 0 20px;
            }
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 40px;
            }
        }
        
        /* ëª¨ë°”ì¼ (480px - 575px) */
        @media (min-width: 480px) and (max-width: 575px) {
            .question-bar {
                height: 130px;
                font-size: 1.1rem;
            }
            .character {
                width: 240px;
                height: 240px;
            }
            .face {
                width: 240px;
                height: 240px;
            }
            .uibox-bg {
                width: 92vw;
                min-height: 130px;
                padding: 0 20px;
                gap: 15px;
                bottom: 30px;
            }
            .uibox-input {
                font-size: 0.95rem;
                height: 50px;
                padding: 0 15px;
            }
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 35px;
            }
            .submit-button .btn-label {
                font-size: 0.9rem;
            }
        }
        
        /* ì†Œí˜• ëª¨ë°”ì¼ (320px - 479px) */
        @media (min-width: 320px) and (max-width: 479px) {
            .question-bar {
                height: 120px;
                font-size: 1rem;
            }
            .character {
                width: 200px;
                height: 200px;
            }
            .face {
                width: 200px;
                height: 200px;
            }
            .uibox-bg {
                width: 94vw;
                min-height: 120px;
                padding: 0 15px;
                gap: 12px;
                bottom: 25px;
            }
            .uibox-input {
                font-size: 0.9rem;
                height: 45px;
                padding: 0 12px;
            }
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 30px;
            }
            .submit-button .btn-label {
                font-size: 0.8rem;
            }
        }
        
        /* ì´ˆì†Œí˜• ëª¨ë°”ì¼ (320px ë¯¸ë§Œ) */
        @media (max-width: 319px) {
            .question-bar {
                height: 110px;
                font-size: 0.9rem;
            }
            .character {
                width: 160px;
                height: 160px;
            }
            .face {
                width: 160px;
                height: 160px;
            }
            .uibox-bg {
                width: 96vw;
                min-height: 110px;
                padding: 0 10px;
                gap: 10px;
                bottom: 20px;
            }
            .uibox-input {
                font-size: 0.85rem;
                height: 40px;
                padding: 0 10px;
            }
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 25px;
            }
            .submit-button .btn-label {
                font-size: 0.75rem;
            }
        }
        
        /* ì„¸ë¡œ í™”ë©´ (ë†’ì´ê°€ ë„ˆë¹„ë³´ë‹¤ ì‘ì€ ê²½ìš°) */
        @media (orientation: portrait) {
            .character-center {
                min-height: 300px;
                padding-top: 40px;
            }
        }
        
        /* ì„¸ë¡œê°€ ê¸´ í™”ë©´ (iPhone 12 Pro ë“±) ìµœì í™” */
        @media (orientation: portrait) and (min-height: 800px) {
            .question-bar {
                height: 120px;
                font-size: 1.1rem;
            }
            
            .character-center {
                min-height: 400px;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            
            .character {
                width: 280px;
                height: 280px;
                margin: 0 auto 1rem auto;
            }
            
            .face {
                width: 280px;
                height: 280px;
            }
            
            .uibox-bg {
                width: 90vw;
                min-height: 120px;
                padding: 0 20px;
                gap: 15px;
                bottom: 30px;
            }
            
            .uibox-input {
                font-size: 1rem;
                height: 50px;
                padding: 0 15px;
            }
            
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 35px;
            }
            
            .submit-button .btn-label {
                font-size: 0.9rem;
            }
        }
        
        /* ë§¤ìš° ì„¸ë¡œê°€ ê¸´ í™”ë©´ (iPhone 12 Pro Max ë“±) */
        @media (orientation: portrait) and (min-height: 900px) {
            .question-bar {
                height: 130px;
                font-size: 1.2rem;
            }
            
            .character-center {
                min-height: 450px;
                padding-top: 30px;
                padding-bottom: 30px;
            }
            
            .character {
                width: 320px;
                height: 320px;
                margin: 0 auto 1.5rem auto;
            }
            
            .face {
                width: 320px;
                height: 320px;
            }
            
            .uibox-bg {
                width: 85vw;
                min-height: 130px;
                padding: 0 25px;
                gap: 20px;
                bottom: 40px;
            }
            
            .uibox-input {
                font-size: 1.1rem;
                height: 55px;
                padding: 0 20px;
            }
            
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 40px;
            }
            
            .submit-button .btn-label {
                font-size: 1rem;
            }
        }
        
        /* iPhone 12 Pro íŠ¹ì • ìµœì í™” (390x844) */
        @media (width: 390px) and (height: 844px) {
            .question-bar {
                height: 110px;
                font-size: 1rem;
            }
            
            .character-center {
                min-height: 350px;
                padding-top: 15px;
                padding-bottom: 15px;
            }
            
            .character {
                width: 240px;
                height: 240px;
                margin: 0 auto 0.8rem auto;
            }
            
            .face {
                width: 240px;
                height: 240px;
            }
            
            .uibox-bg {
                width: 92vw;
                min-height: 110px;
                padding: 0 18px;
                gap: 12px;
                bottom: 25px;
            }
            
            .uibox-input {
                font-size: 0.95rem;
                height: 48px;
                padding: 0 15px;
            }
            
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 32px;
            }
            
            .submit-button .btn-label {
                font-size: 0.85rem;
            }
        }
        
        /* iPhone 12 Pro Max íŠ¹ì • ìµœì í™” (428x926) */
        @media (width: 428px) and (height: 926px) {
            .question-bar {
                height: 120px;
                font-size: 1.1rem;
            }
            
            .character-center {
                min-height: 380px;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            
            .character {
                width: 260px;
                height: 260px;
                margin: 0 auto 1rem auto;
            }
            
            .face {
                width: 260px;
                height: 260px;
            }
            
            .uibox-bg {
                width: 90vw;
                min-height: 120px;
                padding: 0 20px;
                gap: 15px;
                bottom: 30px;
            }
            
            .uibox-input {
                font-size: 1rem;
                height: 52px;
                padding: 0 18px;
            }
            
            .submit-button .btn-img,
            .stt-button .btn-img {
                height: 35px;
            }
            
            .submit-button .btn-label {
                font-size: 0.9rem;
            }
        }
        
        /* ê°€ë¡œ í™”ë©´ (ë„ˆë¹„ê°€ ë†’ì´ë³´ë‹¤ í° ê²½ìš°) */
        @media (orientation: landscape) and (max-height: 600px) {
            .question-bar {
                height: 100px;
                font-size: 1rem;
            }
            .character {
                width: 180px;
                height: 180px;
            }
            .face {
                width: 180px;
                height: 180px;
            }
            .uibox-bg {
                min-height: 100px;
                bottom: 15px;
            }
            .character-center {
                min-height: 200px;
                padding-top: 20px;
            }
        }
        
        /* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ìµœì í™” */
        @media (hover: none) and (pointer: coarse) {
            .submit-button,
            .stt-button {
                min-height: 44px;
                min-width: 44px;
            }
            
            .uibox-input {
                min-height: 44px;
            }
            

        }
        
        /* iPhone ë…¸ì¹˜/í™ˆ ì¸ë””ì¼€ì´í„° ì•ˆì „ ì˜ì—­ */
        @supports (padding: max(0px)) {
            .uibox-bg {
                padding-bottom: max(20px, env(safe-area-inset-bottom));
                bottom: max(20px, env(safe-area-inset-bottom));
            }
            
            .question-bar {
                padding-top: max(10px, env(safe-area-inset-top));
            }
        }
        
        /* ì„¸ë¡œê°€ ê¸´ í™”ë©´ì—ì„œ ë²„íŠ¼ì´ ì§¤ë¦¬ì§€ ì•Šë„ë¡ ë³´ì¥ */
        @media (orientation: portrait) and (min-height: 800px) {
            body {
                min-height: 100vh;
                min-height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
            }
            
            .uibox-bg {
                position: fixed;
                bottom: max(20px, env(safe-area-inset-bottom, 20px));
                left: 50%;
                transform: translateX(-50%);
                z-index: 1000;
            }
        }
        
        /* ê³ í•´ìƒë„ ë””ìŠ¤í”Œë ˆì´ ìµœì í™” */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .uibox-input {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
    .textbar-container {
        position: fixed;
        left: 0;
        bottom: 80px;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        pointer-events: none; /* ì…ë ¥ì°½ë§Œ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
        z-index: 20;
        /* ë‚´ë¶€ ì ˆëŒ€ë°°ì¹˜ìš© */
        flex-direction: column;
    }
    .textbar-bg {
        display: block;
        max-width: 600px;
        width: 100%;
        height: auto;
        pointer-events: none;
    }
    .answer-input-on-image {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 120px); /* ì¢Œìš° ì—¬ë°± 60pxì”© */
        max-width: 480px;
        min-width: 180px;
        padding: 0.8rem 1rem;
        border: 2px solid #ddd;
        border-radius: 10px;
        font-size: 1.1rem;
        background: rgba(255,255,255,0.85);
        pointer-events: auto;
        z-index: 2;
        box-sizing: border-box;
    }
    .button-group-on-image {
        position: absolute;
        right: 30px;
        bottom: 18px;
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
        pointer-events: auto;
        z-index: 3;
    }
    .button-group-on-image .submit-button, .button-group-on-image .stt-button {
        padding: 0.6rem 1.2rem;
        font-size: 1rem;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.95;
    }
    .button-group-on-image .submit-button {
        background-color: #4CAF50;
        color: white;
    }
    .button-group-on-image .submit-button:hover {
        background-color: #45a049;
        transform: scale(1.05);
    }
    .button-group-on-image .stt-button {
        background-color: #E91E63;
        color: white;
    }
    .button-group-on-image .stt-button:hover {
        background-color: #C2185B;
        transform: scale(1.05);
    }
    @media (max-width: 700px) {
        .textbar-bg {
            max-width: 98vw;
        }
        .answer-input-on-image {
            width: 70vw;
            max-width: 95vw;
        }
        .button-group-on-image {
            right: 10px;
            bottom: 10px;
        }
    }
    .textbar-fixed-wrapper {
        position: fixed;
        left: 50%;
        bottom: 40px;
        transform: translateX(-50%);
        width: 1212px;
        height: 217px;
        z-index: 20;
        display: block;
    }
    .textbar-bg {
        width: 1212px;
        height: 217px;
        display: block;
    }
    .answer-input-on-image {
        position: absolute;
        left: 60px;
        top: 50%;
        transform: translateY(-50%);
        width: 800px;
        height: 60px;
        font-size: 1.3rem;
        border: 2px solid #ddd;
        border-radius: 12px;
        background: rgba(255,255,255,0.85);
        z-index: 2;
        box-sizing: border-box;
        padding: 1rem 1.2rem;
    }
    .button-group-on-image {
        position: absolute;
        right: 60px;
        bottom: 32px;
        display: flex;
        gap: 1rem;
        z-index: 3;
    }
    .button-group-on-image .submit-button,
    .button-group-on-image .stt-button {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        opacity: 0.95;
    }
    .button-group-on-image .submit-button { background: #4CAF50; color: #fff; }
    .button-group-on-image .submit-button:hover { background: #45a049; }
    .button-group-on-image .stt-button { background: #E91E63; color: #fff; }
    .button-group-on-image .stt-button:hover { background: #C2185B; }
    .answer-image-bar-wrapper {
        position: fixed;
        left: 50%;
        bottom: 40px;
        transform: translateX(-50%);
        display: flex;
        flex-direction: row;
        align-items: center;
        z-index: 20;
    }
    .answer-input-image-bg {
        width: 600px;
        height: 120px;
        font-size: 1.3rem;
        border: none;
        border-radius: 0;
                    background: url('./images/textbar2.png') no-repeat center/cover;
        color: #222;
        padding: 0 40px;
        box-sizing: border-box;
        outline: none;
        /* placeholder ìŠ¤íƒ€ì¼ */
    }
    .answer-input-image-bg::placeholder {
        color: #888;
        font-size: 1.2rem;
        opacity: 1;
    }
    .button-group-inline {
        display: flex;
        flex-direction: row;
        gap: 1rem;
        margin-left: 20px;
    }
    .button-group-inline .submit-button,
    .button-group-inline .stt-button {
        padding: 1rem 2rem;
        font-size: 1.2rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        opacity: 0.95;
    }
    .button-group-inline .submit-button { background: #4CAF50; color: #fff; }
    .button-group-inline .submit-button:hover { background: #45a049; }
    .button-group-inline .stt-button { background: #E91E63; color: #fff; }
    .button-group-inline .stt-button:hover { background: #C2185B; }
    .detail-btn {
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    .detail-btn-img {
        width: 40px;
        height: auto;
        display: block;
    }
    .detail-modal-content {
                    background: url('./images/note.png') no-repeat center center !important;
        background-size: cover !important;
        border-radius: 16px;
        max-width: 600px;
        max-height: 80vh;
        margin: 50px auto;
        padding: 1.2em;
        box-shadow: 0 4px 32px rgba(0,0,0,0.18);
        position: relative;
        font-size: 0.95em;
        overflow-y: auto;
        overflow-x: hidden;
    }
    .main-result-text {
        color: rgb(254,157,41);
        font-size: 1.2em;
        font-weight: bold;
        text-shadow: 1.5px 1.5px 0 rgb(0, 0, 0);
    }
    
    /* ë¦¬ë·° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ ê°œì„  */
    .modal-content {
        background: white;
        border-radius: 16px;
        max-width: 500px;
        margin: 60px auto;
        padding: 2em;
        box-shadow: 0 4px 32px rgba(0,0,0,0.18);
        position: relative;
        font-size: 0.95em;
        max-height: 80vh;
        overflow-y: auto;
    }
    
    .review-section h3 {
        color: #2c3e50;
        margin-bottom: 1rem;
        font-family: 'HeirofBold';
    }
    
    .review-section h4 {
        color: #2c3e50;
        margin-bottom: 0.5rem;
        font-family: 'HeirofBold';
        font-size: 1.1em;
    }
    
    .review-section p {
        line-height: 1.6;
        margin-bottom: 0.5rem;
        font-family: 'HeirofLight';
    }
    
    .review-section strong {
        color: #2c3e50;
        font-family: 'HeirofBold';
    }
    
    /* ìš”ì•½ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .summary-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 0.8rem;
        margin-bottom: 0.5rem;
        border-left: 4px solid #007bff;
        font-size: 0.95em;
    }
    
    .summary-section p {
        margin: 0;
        color: #495057;
        line-height: 1.4;
    }
    
    .summary-section strong {
        color: #2c3e50;
        font-weight: bold;
    }
    
    /* ìƒì„¸ ë‚´ìš© í† ê¸€ ë²„íŠ¼ */
    .toggle-detail-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        font-family: 'HeirofLight';
        transition: background-color 0.3s;
    }
    
    .toggle-detail-btn:hover {
        background: #0056b3;
    }
    
    /* AI ìš”ì•½ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
    .rotating-hourglass {
        font-size: 2em;
        animation: rotate 1s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .ai-summary-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .ai-summary-box h4 {
        margin: 0 0 0.5rem 0;
        color: white;
    }
    
    .summary-item {
        background: rgba(255, 255, 255, 0.1);
        padding: 0.8rem;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        border-left: 4px solid rgba(255, 255, 255, 0.5);
    }
    
    /* ëª¨ë°”ì¼ í™˜ê²½ì—ì„œ ë¦¬ë·° ëª¨ë‹¬ ìµœì í™” */
    @media (max-width: 768px) {
        .modal-content {
            max-width: 95vw;
            margin: 20px auto;
            padding: 1.5em;
            max-height: 85vh;
        }
        
        .detail-modal-content {
            max-width: 95vw;
            max-height: 85vh;
            margin: 20px auto;
            padding: 1.5em;
        }
        
        .review-section h3 {
            font-size: 1.2em;
        }
        
        .review-section h4 {
            font-size: 1em;
        }
        
        .summary-section {
            padding: 0.8rem;
            margin-bottom: 0.3rem;
        }
        
        .toggle-detail-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 480px) {
        .modal-content {
            max-width: 98vw;
            margin: 10px auto;
            padding: 1em;
        }
        
        .detail-modal-content {
            max-width: 98vw;
            max-height: 90vh;
            margin: 10px auto;
            padding: 1em;
        }
        
        .review-section h3 {
            font-size: 1.1em;
        }
        
        .summary-section {
            padding: 0.6rem;
        }
        
        .toggle-detail-btn {
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
        }
    }
    </style>
</head>
<body>
    <!-- í™ˆ ë²„íŠ¼ -->
    <div class="home-button" onclick="goHome()" title="í™ˆìœ¼ë¡œ ê°€ê¸°">ğŸ </div>
    
    <div class="question-bar" id="questionBar">
        <div id="question">ì§ˆë¬¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
    <div class="character-center">
        <div class="character">
            <div class="face face-neutral" id="characterFace"></div>
        </div>
        <div id="resultGraph" style="display: none;"></div>
    </div>
    <!-- ì´ë¯¸ì§€ UIë°•ìŠ¤ ì•ˆì— ì…ë ¥ì°½, ì œì¶œ, ìŒì„± ë²„íŠ¼ -->
    <div class="uibox-bg">
        <input type="text" class="uibox-input" id="answerInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">
        <button class="submit-button" id="submitButton" onclick="submitAnswer()">
                                <img src="./images/button2.png" alt="ì œì¶œ" class="btn-img">
            <span class="btn-label">ì œì¶œ</span>
        </button>
        <button class="stt-button" id="sttButton" onclick="startSTT()">
            <img src="./images/mic.png" alt="ìŒì„± ì…ë ¥" class="btn-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <span class="mic-fallback" style="display:none; color:#fff; font-size:1.2rem; font-weight:bold;">ğŸ¤</span>
        </button>
        <!-- í–¥ìƒëœ STT í† ê¸€ ë²„íŠ¼ ì£¼ì„ì²˜ë¦¬
        <button class="enhanced-stt-button" id="enhancedSTTButton" onclick="toggleEnhancedSTT()" title="í–¥ìƒëœ STT ê¸°ëŠ¥ í† ê¸€">
            <span id="enhancedSTTIcon">ğŸ”§</span>
            <span id="enhancedSTTLabel">ê¸°ë³¸</span>
        </button>
        -->
    </div>

    <style>
    #question{
        font-family: 'HeirofBold';
    }
    #answerInput, .btn-label{
        font-family: 'HeirofLight';
    }
    
    #answerInput::placeholder {
        font-family: 'HeirofLight';
    }

    .uibox-bg {
        width: 800px;
        min-height: 150px;
        height: auto;
        max-width: 90vw;
                    background: url('./images/textbar2.png') no-repeat center/contain;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 24px;
        z-index: 20;
        box-sizing: border-box;
        padding: 0 40px;
        overflow: visible;
        position: fixed;
        left: 50%;
        bottom: 40px;
        transform: translateX(-50%);
    }

    /* ëª¨ë°”ì¼ í™˜ê²½ ëŒ€ì‘ */
    @media (max-width: 768px) {
        .uibox-bg {
            width: 95vw;
            max-width: 95vw;
            padding: 0 20px;
            gap: 12px;
            bottom: 20px;
        }
        
        .uibox-input {
            font-size: 1rem;
            padding: 0 12px;
        }
        
        .submit-button .btn-img,
        .stt-button .btn-img {
            height: 36px;
            width: 36px;
        }
        
        .submit-button .btn-label {
            font-size: 0.9rem;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ë§ˆì´í¬ ë²„íŠ¼ì„ ì˜¤ë¥¸ìª½ ìƒë‹¨ìœ¼ë¡œ ì´ë™ */
        .stt-button {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            bottom: auto !important;
            left: auto !important;
            transform: none !important;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7) !important;
            border-radius: 50% !important;
            width: 50px !important;
            height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid rgba(255, 255, 255, 0.3) !important;
        }

        /* ëª¨ë°”ì¼ì—ì„œ í–¥ìƒëœ STT ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .enhanced-stt-button {
            min-width: 100px !important;
            font-size: 0.9rem !important;
            padding: 0.6rem 1rem !important;
        }

        .stt-button .btn-img {
            height: 24px !important;
            width: 24px !important;
        }

        .mic-fallback {
            font-size: 1.2rem !important;
            color: #fff !important;
        }
    }

    /* ë§¤ìš° ì‘ì€ í™”ë©´ ëŒ€ì‘ */
    @media (max-width: 480px) {
        .uibox-bg {
            width: 98vw;
            max-width: 98vw;
            padding: 0 10px;
            gap: 8px;
            bottom: 10px;
        }
        
        .uibox-input {
            font-size: 0.9rem;
            padding: 0 8px;
        }
        
        .submit-button .btn-img {
            height: 32px;
            width: 32px;
        }
        
        .submit-button .btn-label {
            font-size: 0.8rem;
        }

        /* ì‘ì€ í™”ë©´ì—ì„œ ë§ˆì´í¬ ë²„íŠ¼ í¬ê¸° ì¡°ì • */
        .stt-button {
            width: 45px !important;
            height: 45px !important;
            top: 15px !important;
            right: 15px !important;
        }

        .stt-button .btn-img {
            height: 20px !important;
            width: 20px !important;
        }

        .mic-fallback {
            font-size: 1rem !important;
        }
    }
    .result-content {
        width: 100%;
        text-align: center;
        padding: 1.2rem 0.5rem;
        box-sizing: border-box;
        overflow-x: auto;
        word-break: break-all;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .uibox-input {
        flex: 1 1 0;
        height: 60px;
        font-size: 1.2rem;
        border: none;
        background: transparent !important;
        color: #fff;
        padding: 0 24px;
        outline: none;
    }
    .uibox-input::placeholder {
        color: #888;
        font-size: 1.1rem;
        opacity: 1;
    }
    
    /* ìë™ì™„ì„± ì„ íƒ ì‹œ ì…ë ¥ì°½ ë°°ê²½ìƒ‰ ê³ ì • */
    .uibox-input:-webkit-autofill,
    .uibox-input:-webkit-autofill:hover,
    .uibox-input:-webkit-autofill:focus,
    .uibox-input:-webkit-autofill:active {
        -webkit-box-shadow: 0 0 0 30px transparent inset !important;
        -webkit-text-fill-color: #fff !important;
        background-color: transparent !important;
        transition: background-color 5000s ease-in-out 0s;
        color: #fff !important;
    }
    
    /* ìë™ì™„ì„± í›„ í…ìŠ¤íŠ¸ ìƒ‰ìƒ ê°•ì œ ê³ ì • */
    .uibox-input:-webkit-autofill {
        -webkit-text-fill-color: #fff !important;
        color: #fff !important;
    }
    
    /* ìë™ì™„ì„± í›„ í¬ì»¤ìŠ¤ ì‹œì—ë„ í°ìƒ‰ ìœ ì§€ */
    .uibox-input:-webkit-autofill:focus {
        -webkit-text-fill-color: #fff !important;
        color: #fff !important;
    }
    
    /* ìë™ì™„ì„± í›„ í˜¸ë²„ ì‹œì—ë„ í°ìƒ‰ ìœ ì§€ */
    .uibox-input:-webkit-autofill:hover {
        -webkit-text-fill-color: #fff !important;
        color: #fff !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ê¸€ì”¨ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-list-button {
        font-size: 1.2rem !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ê¸€ì”¨ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-calendar-picker-indicator {
        font-size: 1.2rem !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ í…ìŠ¤íŠ¸ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-datetime-edit-text {
        font-size: 1.2rem !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ í•„ë“œ ê¸€ì”¨ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-datetime-edit-month-field,
    .uibox-input::-webkit-datetime-edit-day-field,
    .uibox-input::-webkit-datetime-edit-year-field {
        font-size: 1.2rem !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ í˜¸ë²„ ì‹œ ê¸€ì”¨ í¬ê¸° ìœ ì§€ */
    .uibox-input::-webkit-list-button:hover,
    .uibox-input::-webkit-calendar-picker-indicator:hover,
    .uibox-input::-webkit-datetime-edit-text:hover,
    .uibox-input::-webkit-datetime-edit-month-field:hover,
    .uibox-input::-webkit-datetime-edit-day-field:hover,
    .uibox-input::-webkit-datetime-edit-year-field:hover {
        font-size: 1.2rem !important;
        transform: none !important;
        scale: 1 !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ì „ì²´ ê¸€ì”¨ í¬ê¸° ê°•ì œ ê³ ì • */
    .uibox-input::-webkit-autofill,
    .uibox-input::-webkit-autofill:hover,
    .uibox-input::-webkit-autofill:focus,
    .uibox-input::-webkit-autofill:active {
        font-size: 1.2rem !important;
        font-weight: normal !important;
        letter-spacing: normal !important;
        line-height: normal !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ëª¨ë“  ìš”ì†Œ ê¸€ì”¨ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-any-link,
    .uibox-input::-webkit-any-link:hover,
    .uibox-input::-webkit-any-link:active,
    .uibox-input::-webkit-any-link:visited {
        font-size: 1.2rem !important;
        text-decoration: none !important;
    }
    
    /* ìë™ì™„ì„± ë“œë¡­ë‹¤ìš´ ì„ íƒëœ í•­ëª© ê¸€ì”¨ í¬ê¸° ê³ ì • */
    .uibox-input::-webkit-list-button:active,
    .uibox-input::-webkit-calendar-picker-indicator:active,
    .uibox-input::-webkit-datetime-edit-text:active,
    .uibox-input::-webkit-datetime-edit-month-field:active,
    .uibox-input::-webkit-datetime-edit-day-field:active,
    .uibox-input::-webkit-datetime-edit-year-field:active {
        font-size: 1.2rem !important;
        transform: none !important;
        scale: 1 !important;
    }
    .submit-button .btn-img,
    .stt-button .btn-img {
        height: 48px;
        width: auto;
        display: block;
        object-fit: contain;
    }
    .submit-button {
        position: relative;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
    }
    .submit-button .btn-label {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        color: #fff;
        font-size: 1.1rem;
        font-weight: bold;
        pointer-events: none;
        /* text-shadow: 0 1px 4px #000, 0 0 2px #000; */
        white-space: nowrap;
    }
    .stt-button {
        background: none !important;
        border: none;
        min-width: 48px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
    }

    /* ëª¨ë°”ì¼ í™˜ê²½ ëŒ€ì‘ */
    @media (max-width: 768px) {
        .stt-button {
            min-width: 48px;
            min-height: 48px;
            background: rgba(255, 255, 255, 0.1) !important;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        
        .stt-button .btn-img {
            height: 28px;
            width: 28px;
        }
        
        .mic-fallback {
            font-size: 1.2rem !important;
        }
    }

    /* ë§¤ìš° ì‘ì€ í™”ë©´ ëŒ€ì‘ */
    @media (max-width: 480px) {
        .stt-button {
            min-width: 40px;
            min-height: 40px;
        }
        
        .stt-button .btn-img {
            height: 24px;
            width: 24px;
        }
        
        .mic-fallback {
            font-size: 1rem !important;
        }
    }

    /* STT ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .stt-modal-content {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 32px rgba(0,0,0,0.18);
    }

    .stt-modal-content h3 {
        margin-bottom: 1rem;
        color: #333;
    }

    .stt-modal-content button {
        transition: background-color 0.3s;
    }

    .stt-modal-content button:hover {
        background-color: #c82333 !important;
    }
    .detail-btn {
        position: absolute;
        right: -60px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .detail-btn-img {
        width: 40px;
        height: auto;
        display: block;
    }
    .next-btn {
        position: static;
        margin-top: 0.7em;
        margin-bottom: 0;
        margin-right: calc(50vw - 400px);
        margin-left: auto;
        padding: 0.8em 2.5em;
        font-size: 1.1em;
        border-radius: 8px;
        border: none;
        background: #2196F3;
        color: #fff;
        font-weight: bold;
        cursor: pointer;
        transition: background 0.2s;
        display: block;
        font-family: 'HeirofBold';
    }
    .next-btn:hover {
        background: #1976D2;
    }
    /* ëª¨ë°”ì¼ ìµœì í™” ìŠ¤íƒ€ì¼ */
    @media (max-width: 768px) {
        .stt-modal {
            padding: 1rem;
            margin: 1rem;
            border-radius: 12px;
        }
        
        .stt-modal h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }
        
        .stt-modal p {
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .stt-modal button {
            padding: 0.8rem 1.2rem;
            font-size: 1rem;
            margin: 0.5rem;
            min-width: 120px;
        }
        
        .stt-modal .button-group {
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .stt-modal .button-group button {
            width: 100%;
            max-width: 200px;
        }
    }
    </style>
    
    <!-- ê¸°ì¡´ í•˜ë‹¨ ë©”ì‹œì§€ ì‚­ì œ ë° ëª¨ë‹¬ ì¶”ê°€ -->
    <!-- <div id="loadingMessage" style="display:none; color:#2196F3; font-weight:bold; margin-top:1rem;">
        <span id="loadingText" style="font-family: 'HeirofLight';">AIê°€ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤</span><span id="loadingDots"></span>
    </div> -->
    <div id="loadingModal" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.35); z-index:20000; align-items:center; justify-content:center;">
      <div style="background:white; border-radius:18px; box-shadow:0 4px 32px rgba(0,0,0,0.18); padding:2.5em 2em; min-width:220px; display:flex; flex-direction:column; align-items:center;">
        <div style="font-size:1.3em; color:#7C3AED; font-family:'HeirofBold'; margin-bottom:1em;"><span class="rotating-hourglass">â³</span> AIê°€ ë¶„ì„ì¤‘ì…ë‹ˆë‹¤...</div>
        <div id="loadingDots" style="font-size:2em; color:#7C3AED; letter-spacing:0.2em; margin-bottom:1.5em;">...</div>
        <button id="cancelAnalysisBtn" onclick="cancelAnalysis()" style="background:#ff4757; color:white; border:none; padding:0.8em 1.5em; border-radius:8px; font-size:1rem; cursor:pointer; font-family:'HeirofLight'; transition:all 0.3s ease;">
          âŒ ë¶„ì„ ì·¨ì†Œ
        </button>
      </div>
    </div>


    <script>
        // API ê¸°ë³¸ URL ì„¤ì • - ngrok í˜¸í™˜
        const API_BASE_URL = window.location.origin;
        // ì„ì‹œ ê¸°ë³¸ ì§ˆë¬¸ ë°ì´í„°
        const DEFAULT_QUESTIONS = [
            'ë‹¹ì‹ ì´ ìµœê·¼ì— ë‚´ë¦° ê°€ì¥ í° ê²°ì •ì€ ë¬´ì—‡ì¸ê°€ìš”?',
            'ì¹œêµ¬ê°€ ê³ ë¯¼ì„ í„¸ì–´ë†“ì„ ë•Œ ë‹¹ì‹ ì˜ ì²« ë°˜ì‘ì€?',
            'ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ ì–´ë–»ê²Œ í•´ê²°í•˜ë ¤ê³  í•˜ë‚˜ìš”?',
            'ê°ì •ì´ ê²©í•´ì§ˆ ë•Œ ì£¼ë¡œ ì–´ë–»ê²Œ ëŒ€ì²˜í•˜ë‚˜ìš”?',
            'ì¤‘ìš”í•œ ì„ íƒì„ í•  ë•Œ ë¬´ì—‡ì„ ê°€ì¥ ìš°ì„ ì‹œí•˜ë‚˜ìš”?'
        ];
        // ì „ì—­ ë³€ìˆ˜
        let currentCount = 0;
        let maxCount = 0;
        let results = [];
        let usedQuestions = new Set();
        let questions = [];
        // ì „ì—­ ë³€ìˆ˜ ì¶”ê°€
        let lastResultData = null;

        // API ì„œë²„ ìƒíƒœ ì²´í¬ í•¨ìˆ˜ (ëª¨ë°”ì¼ ìµœì í™”)
        async function checkApiServer(retryCount = 3) {
            for (let i = 0; i < retryCount; i++) {
                try {
                    console.log(`API ì„œë²„ ìƒíƒœ ì²´í¬ ì‹œë„ ${i + 1}/${retryCount}`);
                    
                    // ëª¨ë°”ì¼ì—ì„œ ë” ê¸´ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
                    
                    const res = await fetch(`${API_BASE_URL}/questions?use_ai=false`, { 
                        method: 'GET',
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (res.ok) {
                        console.log('API ì„œë²„ ì—°ê²° ì„±ê³µ');
                        return true;
                    }
                } catch (e) {
                    console.log(`API ì„œë²„ ì²´í¬ ì‹¤íŒ¨ (ì‹œë„ ${i + 1}):`, e);
                    if (i < retryCount - 1) {
                        // ì¬ì‹œë„ ì „ ì ì‹œ ëŒ€ê¸° (ëª¨ë°”ì¼ì—ì„œëŠ” ë” ê¸´ ëŒ€ê¸°)
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
            }
            console.log('API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ - ëª¨ë“  ì¬ì‹œë„ ì™„ë£Œ');
            return false;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', async function() {
            // URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
            const urlParams = new URLSearchParams(window.location.search);
            const count = parseInt(urlParams.get('count')) || 5;
            const source = urlParams.get('source') || 'default';
            
            let settings = {
                count: count,
                source: source,
                questionCount: count,
                questionSource: source
            };
            
            console.log('URL íŒŒë¼ë¯¸í„°ì—ì„œ ì„¤ì • ë¡œë“œ:', settings);
            console.log('ì§ˆë¬¸ ì†ŒìŠ¤:', source);
            console.log('ì„¤ì •ëœ questionSource:', settings.questionSource);
            console.log('=== ë””ë²„ê·¸ ì •ë³´ ===');
            console.log('URL ì „ì²´:', window.location.href);
            console.log('URL íŒŒë¼ë¯¸í„°:', window.location.search);
            console.log('source íŒŒë¼ë¯¸í„°:', urlParams.get('source'));
            console.log('count íŒŒë¼ë¯¸í„°:', urlParams.get('count'));
            console.log('==================');
            
            // API ì„œë²„ ìƒíƒœ ë¨¼ì € í™•ì¸ (ì¬ì‹œë„ í¬í•¨)
            const apiAlive = await checkApiServer();
            if (!apiAlive) {
                console.log('API ì„œë²„ ì—°ê²° ì‹¤íŒ¨ - ê¸°ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ì§„í–‰');
                alert('ì§ˆë¬¸ ì„œë²„(API)ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.\n\nì„œë²„ê°€ ì‹¤í–‰ ì¤‘ì´ë¼ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ë³´ì„¸ìš”.');
                maxCount = DEFAULT_QUESTIONS.length;
                questions = [...DEFAULT_QUESTIONS];
                currentCount = 0; // ì¹´ìš´íŠ¸ ì´ˆê¸°í™” ì¶”ê°€
                initCharacter();
                showNextQuestion();
                return;
            }
            
            maxCount = count;
            currentCount = 0; // ì¹´ìš´íŠ¸ ì´ˆê¸°í™” ì¶”ê°€
            console.log('ì„¤ì •ëœ ì§ˆë¬¸ ìˆ˜:', maxCount); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            initCharacter();
            loadQuestions(settings);
        });

        // ì§ˆë¬¸ ë°ì´í„° ë¡œë“œ (ë§¤ë²ˆ ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„±)
        async function loadQuestions(settings) {
            try {
                const count = settings.questionCount || 5;
                const questionSource = settings.questionSource || 'default';
                console.log('ì§ˆë¬¸ ë¡œë“œ ìš”ì²­ - ê°œìˆ˜:', count, ', ì†ŒìŠ¤:', questionSource); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                
                let url;
                if (questionSource === 'question2') {
                    // question2.json ë¡œë“œ (êµ¬ì–´ì²´ ì§ˆë¬¸ + ì¸í„°ë„· ë°ˆ)
                    url = `${API_BASE_URL}/question/question2.json`;
                } else if (questionSource === 'ai') {
                    // AI ì§ˆë¬¸ ìƒì„±
                    url = `${API_BASE_URL}/api/v1/questions?use_ai=true`;
                } else {
                    // ê¸°ë³¸ question2.json ë¡œë“œ (fallback)
                    url = `${API_BASE_URL}/question/question2.json`;
                }
                
                const response = await fetch(url);
                if (!response.ok) throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
                const data = await response.json();
                if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                    throw new Error('ì§ˆë¬¸ ë°ì´í„° ì—†ìŒ');
                }
                
                // Fisher-Yates ì…”í”Œ ì•Œê³ ë¦¬ì¦˜ìœ¼ë¡œ ì§ˆë¬¸ë“¤ì„ ì…”í”Œ
                const shuffled = [...data.questions];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                questions = shuffled;
                // maxCountëŠ” ë©”ì¸ì—ì„œ ì„¤ì •í•œ count ê°’ìœ¼ë¡œ ìœ ì§€ (API ì§ˆë¬¸ ìˆ˜ë¡œ ë®ì–´ì“°ì§€ ì•ŠìŒ)
                console.log('ì§ˆë¬¸ ë¡œë“œ ë° ì…”í”Œ ì™„ë£Œ - ê°œìˆ˜:', questions.length, ', ì„¤ì •ëœ maxCount:', maxCount, ', ì†ŒìŠ¤:', questionSource); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                showNextQuestion();
            } catch (error) {
                console.error('Error loading questions:', error);
                // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ì§ˆë¬¸ ì‚¬ìš©
                questions = [...DEFAULT_QUESTIONS];
                // maxCountëŠ” ë©”ì¸ì—ì„œ ì„¤ì •í•œ count ê°’ìœ¼ë¡œ ìœ ì§€
                console.log('ê¸°ë³¸ ì§ˆë¬¸ ì‚¬ìš© - ê°œìˆ˜:', questions.length, ', ì„¤ì •ëœ maxCount:', maxCount); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
                showNextQuestion();
            }
        }

        // ìºë¦­í„° ì´ˆê¸°í™”
        function initCharacter() {
            const character = document.getElementById('characterFace');
            if (character) {
                character.className = 'face face-neutral';
            }
            document.querySelector('.character-center').style.paddingTop = '100px';
        }

        // í‘œì • ë³€ê²½
        function updateCharacterExpression(score) {
            const face = document.getElementById('characterFace');
            if (face) {
                face.className = 'face';
                if (score < 20) face.classList.add('face-very-angry');
                else if (score < 40) face.classList.add('face-angry');
                else if (score < 60) face.classList.add('face-neutral');
                else if (score < 80) face.classList.add('face-happy');
                else face.classList.add('face-very-happy');
            }
            document.querySelector('.character-center').style.paddingTop = '60px';
        }

        // ëœë¤ ì§ˆë¬¸ ì„ íƒ
        function getRandomQuestion() {
            const availableQuestions = questions.filter((_, index) => !usedQuestions.has(index));
            if (availableQuestions.length === 0) {
                usedQuestions.clear();
                return questions[Math.floor(Math.random() * questions.length)];
            }
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const questionIndex = questions.findIndex(q => q === availableQuestions[randomIndex]);
            usedQuestions.add(questionIndex);
            return availableQuestions[randomIndex];
        }

        // ë‹¤ìŒ ì§ˆë¬¸ í‘œì‹œ
        function showNextQuestion() {
            document.querySelector('.character-center').style.paddingTop = '100px';
            // ì…”í”Œëœ ì§ˆë¬¸ ë°°ì—´ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì„ íƒ
            const question = questions[currentCount];
            document.getElementById('question').textContent = question;
            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').disabled = false;
            document.getElementById('resultGraph').style.display = 'none';
            document.querySelector('.submit-button').disabled = false;
            document.querySelector('.submit-button').style.opacity = '1';
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë¶„ì„ ìš”ì²­ì˜ AbortController ì €ì¥
        let currentAnalysisController = null;

        // ë¶„ì„ ì·¨ì†Œ í•¨ìˆ˜
        function cancelAnalysis() {
            if (currentAnalysisController) {
                currentAnalysisController.abort();
                currentAnalysisController = null;
            }
            hideLoadingModal();
            console.log('ë¶„ì„ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // ë‹µë³€ ì œì¶œ (ëª¨ë°”ì¼ ìµœì í™”)
        async function submitAnswer() {
            const answer = document.getElementById('answerInput').value.trim();
            if (!answer) {
                alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            showLoadingModal();

            try {
                // ëª¨ë°”ì¼ì—ì„œ ë” ê¸´ íƒ€ì„ì•„ì›ƒ ì„¤ì •
                currentAnalysisController = new AbortController();
                const timeoutId = setTimeout(() => currentAnalysisController.abort(), 15000); // 15ì´ˆ íƒ€ì„ì•„ì›ƒ
                
                const response = await fetch(`${API_BASE_URL}/analyze`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ text: answer }),
                    signal: currentAnalysisController.signal
                });

                clearTimeout(timeoutId);

                if (!response.ok) {
                    throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                }

                const data = await response.json();
                
                // ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
                if (!data || typeof data.score === 'undefined') {
                    throw new Error('API ì‘ë‹µ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                console.log('ğŸ“Š API ì‘ë‹µ ë°ì´í„°:', data);
                console.log('ğŸ“‹ ìƒì„¸ë¶„ì„:', data.detailed_analysis);
                console.log('ğŸ” ë¶„ì„ê·¼ê±°:', data.reasoning);
                console.log('ğŸ’¡ ê°œì„ ì œì•ˆ:', data.suggestions);
                console.log('ğŸ” ë°ì´í„° íƒ€ì… í™•ì¸:');
                console.log('  - detailed_analysis íƒ€ì…:', typeof data.detailed_analysis);
                console.log('  - reasoning íƒ€ì…:', typeof data.reasoning);
                console.log('  - suggestions íƒ€ì…:', typeof data.suggestions);
                console.log('  - suggestions ê¸¸ì´:', Array.isArray(data.suggestions) ? data.suggestions.length : 'ë°°ì—´ ì•„ë‹˜');
                
                results.push({
                    question: document.getElementById('question').textContent,
                    answer: answer,
                    score: data.score,
                    detailed_analysis: data.detailed_analysis,
                    reasoning: data.reasoning,
                    suggestions: data.suggestions,
                    alternative_response: data.alternative_response
                });
                lastResultData = data; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                console.log('ğŸ’¾ lastResultData ì €ì¥ ì™„ë£Œ:', lastResultData);
                currentAnalysisController = null; // ì»¨íŠ¸ë¡¤ëŸ¬ ì´ˆê¸°í™”
                hideLoadingModal();
                showResult(data); // tfScoreê°€ ì•„ë‹ˆë¼ data ì „ì²´ë¥¼ ë„˜ê¹€
            } catch (error) {
                console.error('Error:', error);
                
                // ì·¨ì†Œëœ ê²½ìš° ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                if (error.name === 'AbortError' && !currentAnalysisController) {
                    console.log('ë¶„ì„ì´ ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ëª¨ë°”ì¼ì—ì„œ ë” ì¹œí™”ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€
                let errorMessage = 'ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                if (error.name === 'AbortError') {
                    errorMessage = 'ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMessage = 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                }
                
                alert(errorMessage);
                currentAnalysisController = null; // ì»¨íŠ¸ë¡¤ëŸ¬ ì´ˆê¸°í™”
                hideLoadingModal();
            }
        }

        // showResult í•¨ìˆ˜ ìˆ˜ì •
        function showResult(data) {
            let tfScore = Number(data.score);
            if (isNaN(tfScore)) {
                alert('ë¶„ì„ ê²°ê³¼ ì ìˆ˜ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸°ë³¸ê°’ìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.');
                tfScore = 50;
            }
            // ë¶„ì„ ëë‚¬ìœ¼ë‹ˆ ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
            document.getElementById('loadingModal').style.display = 'none';
            // ì ìˆ˜ì— ë”°ë¼ ìºë¦­í„° í‘œì • ì—…ë°ì´íŠ¸
            updateCharacterExpression(tfScore);
            const uibox = document.querySelector('.uibox-bg');
            const tPercentage = 100 - tfScore;
            const fPercentage = tfScore;
            let resultText = '';
            if (tfScore < 20) resultText = `ë‹¹ì‹ ì€ í™•ì‹¤í•œ Tì…ë‹ˆë‹¤! "ë„ˆ Të°œCì•¼?" (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore <= 40) resultText = `ë‹¹ì‹ ì€ T ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore >= 41 && tfScore <= 59) resultText = `ë‹¹ì‹ ì€ Tì™€ Fì˜ ê· í˜•ì´ ì˜ ì¡í˜€ìˆìŠµë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else if (tfScore < 80) resultText = `ë‹¹ì‹ ì€ F ì„±í–¥ì´ ê°•í•©ë‹ˆë‹¤. (T: ${tPercentage}% / F: ${fPercentage}%)`;
            else resultText = `ë‹¹ì‹ ì€ í™•ì‹¤í•œ Fì…ë‹ˆë‹¤! "ë„ˆ Fêµ¬ë‚˜?" (T: ${tPercentage}% / F: ${fPercentage}%)`;
            uibox.innerHTML = `
                <div class="result-content">
                    <p class="main-result-text" style="font-family: 'HeirofBold';">${resultText}</p>
                    <div style="position: relative; width: 80%; margin: 1.2rem auto;">
                        <div style="width: 100%; height: 24px; background: linear-gradient(to right, #ff4444, #ffff44, #44ff44); border-radius: 12px; position: relative;">
                            <div style="position: absolute; left: ${tfScore}%; top: 20px; transform: translateX(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: clamp(4px, 1vw, 6px) clamp(6px, 2vw, 10px); border-radius: clamp(6px, 1.5vw, 8px); font-size: clamp(0.7em, 2.5vw, 0.9em); font-weight: bold; white-space: nowrap; box-shadow: 0 3px 8px rgba(0,0,0,0.3); border: clamp(1px, 0.3vw, 2px) solid #fff;">
                                ${tfScore.toFixed(1)}ì 
                            </div>
                            <div style="width: clamp(8px, 2vw, 12px); height: clamp(30px, 8vw, 40px); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: clamp(2px, 0.5vw, 3px) solid #fff; border-radius: clamp(4px, 1vw, 6px); position: absolute; left: ${tfScore}%; top: -9px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); transform: translateX(-50%); display: flex; align-items: center; justify-content: center; font-size: clamp(20px, 5vw, 32px); color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);">
                                ${tfScore < 30 ? 'ğŸ˜¤' : tfScore < 50 ? 'ğŸ˜' : tfScore < 70 ? 'ğŸ˜Š' : 'ğŸ˜„'}
                            </div>
                            <div style="position: absolute; left: 5px; top: 50%; transform: translateY(-50%); color: white; font-size: 0.8em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
                                Thinking
                            </div>
                            <div style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); color: white; font-size: 0.8em; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.7);">
                                Feeling
                            </div>
                        </div>
                    </div>
                    <button class="detail-btn" onclick="showDetailAnalysis()">
                        <img src="./Question_pg/note_button.png" alt="ìƒì„¸ ë¶„ì„ ë³´ê¸°" class="detail-btn-img">
                    </button>
                </div>
            `;
            // 'ë‹¤ìŒ' ë˜ëŠ” 'ê²°ê³¼' ë²„íŠ¼ì„ .uibox-bg(ë°•ìŠ¤) ë°– note_button ì•„ë˜ì— ì˜¤ë¥¸ìª½ ì •ë ¬ë¡œ ì¶”ê°€
            let nextBtn = document.querySelector('.next-btn');
            if (!nextBtn) {
                nextBtn = document.createElement('button');
                nextBtn.className = 'next-btn';
                document.querySelector('.uibox-bg').after(nextBtn);
            }
            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë° ë™ì‘ ì„¤ì •
            console.log('í˜„ì¬ ì§ˆë¬¸:', currentCount + 1, '/', maxCount); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            if (currentCount + 1 >= maxCount) {
                nextBtn.textContent = 'ê²°ê³¼';
                nextBtn.onclick = goToResultPage;
                console.log('ê²°ê³¼ ë²„íŠ¼ í‘œì‹œ'); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            } else {
                nextBtn.textContent = 'ë‹¤ìŒ';
                nextBtn.onclick = nextQuestion;
                console.log('ë‹¤ìŒ ë²„íŠ¼ í‘œì‹œ'); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            }
            nextBtn.style.display = 'block';
        }

        // ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ (ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„±)
        async function nextQuestion() {
            currentCount++;
            console.log('ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™ - í˜„ì¬ ì¹´ìš´íŠ¸:', currentCount, '/', maxCount); // ë””ë²„ê¹… ë¡œê·¸ ì¶”ê°€
            
            // ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„±
            if (currentCount < maxCount) {
                try {
                    console.log('ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„± ìš”ì²­...');
                    const url = `${API_BASE_URL}/api/v1/questions?use_ai=false`;
                    
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
                    const data = await response.json();
                    
                    if (data.questions && Array.isArray(data.questions) && data.questions.length > 0) {
                        // ìƒˆë¡œìš´ ì§ˆë¬¸ìœ¼ë¡œ í˜„ì¬ ì§ˆë¬¸ êµì²´
                        questions[currentCount] = data.questions[0];
                        console.log('ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„± ì™„ë£Œ:', data.questions[0]);
                    } else {
                        throw new Error('ìƒˆë¡œìš´ ì§ˆë¬¸ ë°ì´í„° ì—†ìŒ');
                    }
                } catch (error) {
                    console.error('ìƒˆë¡œìš´ ì§ˆë¬¸ ìƒì„± ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œ ê¸°ì¡´ ì§ˆë¬¸ ìœ ì§€
                }
            }
            
            // ê²°ê³¼ì°½/ë²„íŠ¼ ìˆ¨ê¸°ê³ , ì…ë ¥ì°½/ì§ˆë¬¸/ìºë¦­í„° ë“± ì´ˆê¸°í™”
            // ì…ë ¥ì°½, ì§ˆë¬¸, ìºë¦­í„° ë“± index2ì˜ ê¸°ë³¸ UIë¡œ ë³µêµ¬
            // uibox-bgë¥¼ ì›ë˜ ì…ë ¥ì°½ UIë¡œ ë³µì›
            const uibox = document.querySelector('.uibox-bg');
            uibox.innerHTML = `
                <input type="text" class="uibox-input" id="answerInput" placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button class="submit-button" id="submitButton" onclick="submitAnswer()">
                    <img src="./images/button2.png" alt="ì œì¶œ" class="btn-img">
                    <span class="btn-label">ì œì¶œ</span>
                </button>
                <button class="stt-button" id="sttButton" onclick="startSTT()">
                    <img src="./images/mic.png" alt="ìŒì„± ì…ë ¥" class="btn-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <span class="mic-fallback" style="display:none; color:#fff; font-size:1.2rem; font-weight:bold;">ğŸ¤</span>
                </button>
            `;
            // ë‹¤ìŒ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            let nextBtn = document.querySelector('.next-btn');
            if (nextBtn) nextBtn.style.display = 'none';
            // ìºë¦­í„° í‘œì • ì´ˆê¸°í™”
            initCharacter();
            // ë‹¤ìŒ ì§ˆë¬¸ í‘œì‹œ
            showNextQuestion();
        }

        // ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
        function goToResultPage() {
            try {
                console.log('ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ ì‹œì‘...');
                console.log('ì €ì¥í•  ê²°ê³¼:', results);
                
                // ê²°ê³¼ë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                sessionStorage.setItem('mbtiResults', JSON.stringify(results));
                console.log('ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ê²°ê³¼ ì €ì¥ ì™„ë£Œ');
                
                // ìµœì¢… ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™
                console.log('index3.htmlë¡œ ì´ë™...');
                window.location.href = 'index3.html';
            } catch (error) {
                console.error('ê²°ê³¼ í˜ì´ì§€ ì´ë™ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ê²°ê³¼ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // AI ìš”ì•½ í•¨ìˆ˜ (ì£¼ì„ì²˜ë¦¬ë¨)
        /*
        async function getAISummary(text, type) {
            if (!text || text.trim() === '') {
                return 'ìš”ì•½í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/summarize`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: text,
                        type: type
                    })
                });

                if (!response.ok) {
                    throw new Error('AI ìš”ì•½ ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();
                return data.summary || 'AI ìš”ì•½ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            } catch (error) {
                console.error('AI ìš”ì•½ ì˜¤ë¥˜:', error);
                // AI ì‹¤íŒ¨ ì‹œ ê°„ë‹¨í•œ ìš”ì•½ìœ¼ë¡œ ëŒ€ì²´
                return text.length > 100 ? text.substring(0, 100) + '...' : text;
            }
        }
        */



        // ë¡œë”© ì  ì• ë‹ˆë©”ì´ì…˜
        let loadingInterval = null;
        function startLoadingDots() {
            const dots = document.getElementById('loadingDots');
            let count = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                count = (count + 1) % 4;
                dots.textContent = '.'.repeat(count === 0 ? 3 : count);
            }, 400);
        }
        function stopLoadingDots() {
            if (loadingInterval) clearInterval(loadingInterval);
            document.getElementById('loadingDots').textContent = '';
        }

        // STT ê¸°ëŠ¥
        let mediaRecorder = null;
        let audioChunks = [];
        let isRecording = false;

        function startSTT() {
            // ìŒì„±ì¸ì‹ ëª¨ë‹¬ í‘œì‹œ
            showSTTModal();
        }

        // ë…¹ìŒ í† ê¸€ í•¨ìˆ˜ ì¶”ê°€
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
                return;
            }

            // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ì•ˆì „í•œ ì„¤ì • (í•œêµ­ì–´ ê³ ì •)
            const audioConstraints = {
                audio: {
                    sampleRate: 8000,  // 16kHz â†’ 8kHzë¡œ ë‚®ì¶¤
                    channelCount: 1,
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    language: 'ko-KR'  // í•œêµ­ì–´ë¡œ ê³ ì •
                }
            };
            
            navigator.mediaDevices.getUserMedia(audioConstraints)
                .then(stream => {
                    // ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•œ ì•ˆì „í•œ í˜•ì‹ ì„ íƒ
                    let mimeType = 'audio/webm;codecs=opus';
                    
                    // WebMì´ ì§€ì›ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ í˜•ì‹ ì‚¬ìš©
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                    }
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = '';
                    }
                    
                    const options = mimeType ? { mimeType } : {};
                    console.log('ì‚¬ìš©í•  ì˜¤ë””ì˜¤ í˜•ì‹:', mimeType || 'ê¸°ë³¸ í˜•ì‹');
                    
                    mediaRecorder = new MediaRecorder(stream, options);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: mimeType || 'audio/webm' });
                        console.log('ë…¹ìŒ ì™„ë£Œ, íŒŒì¼ í¬ê¸°:', audioBlob.size, 'bytes');
                        sendAudioToServer(audioBlob);
                        
                        // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    
                    // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìŠ¤íƒ€ì¼ ë³€ê²½
                    const recordBtn = document.getElementById('recordToggleBtn');
                    if (recordBtn) {
                        recordBtn.textContent = 'â¹ï¸ ë…¹ìŒ ì¤‘ì§€';
                        recordBtn.style.background = '#ffc107';
                        recordBtn.style.color = '#333';
                    }
                    
                    updateSTTStatus('ğŸ¤ ìŒì„± ë…¹ìŒ ì¤‘... (ë§ì”€í•˜ì‹  í›„ "â¹ï¸ ë…¹ìŒ ì¤‘ì§€" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”)');
                    
                    console.log('ë…¹ìŒ ì‹œì‘ë¨');
                })
                .catch(error => {
                    console.error('ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜:', error);
                    updateSTTStatus('âŒ ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì €ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.');
                    
                    // ëª¨ë°”ì¼ì—ì„œ ê¶Œí•œ ê±°ë¶€ ì‹œ ì•ˆë‚´
                    if (error.name === 'NotAllowedError') {
                        alert('ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.\n\n1. ë¸Œë¼ìš°ì € ì£¼ì†Œì°½ì˜ ë§ˆì´í¬ ì•„ì´ì½˜ì„ í´ë¦­\n2. "í—ˆìš©"ì„ ì„ íƒ\n3. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                });
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ì™€ ìŠ¤íƒ€ì¼ì„ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ê¸°
                const recordBtn = document.getElementById('recordToggleBtn');
                if (recordBtn) {
                    recordBtn.textContent = 'ğŸ¤ ë…¹ìŒ ì‹œì‘';
                    recordBtn.style.background = '#28a745';
                    recordBtn.style.color = 'white';
                }
                
                updateSTTStatus('ğŸ”„ ìŒì„± ë°ì´í„°ë¥¼ ì„œë²„ë¡œ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...');
            }
        }

        function showSTTModal() {
            const modal = document.createElement('div');
            modal.id = 'sttModal';
            modal.className = 'stt-modal';
            modal.innerHTML = `
                <div class="stt-modal-content">
                    <h3>ğŸ¤ ìŒì„±ì¸ì‹ </h3>
                    <div id="sttStatus" style="margin: 1rem 0; font-size: 1.1em; color: #333;">
                        ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì„œ ìŒì„±ì¸ì‹ì„ ì‹œì‘í•˜ì„¸ìš”
                    </div>
                    <div style="margin: 1rem 0; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;" class="button-group">
                        <button id="recordToggleBtn" onclick="toggleRecording()" style="padding: 0.5rem 1rem; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; font-weight: bold;">
                            ğŸ¤ ë…¹ìŒ ì‹œì‘
                        </button>
                        <button onclick="hideSTTModal()" style="padding: 0.5rem 1rem; border-radius: 8px; border: none; background: #dc3545; color: white; cursor: pointer;">
                            ë‹«ê¸°
                        </button>
                    </div>
                </div>
            `;
            
            Object.assign(modal.style, {
                position: 'fixed',
                left: 0,
                top: 0,
                width: '100vw',
                height: '100vh',
                background: 'rgba(0,0,0,0.5)',
                zIndex: 9999,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
            });
            
            document.body.appendChild(modal);
        }

        function hideSTTModal() {
            const modal = document.getElementById('sttModal');
            if (modal) {
                modal.remove();
            }
            if (isRecording) {
                stopRecording();
            }
            // ë…¹ìŒ ìƒíƒœ ì´ˆê¸°í™”
            isRecording = false;
        }

        function updateSTTStatus(message) {
            const statusElement = document.getElementById('sttStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        // ë¬¸ì¥ êµì • í•¨ìˆ˜
        async function correctSentence(originalText) {
            try {
                console.log('ë¬¸ì¥ êµì • ì‹œì‘:', originalText);
                
                const response = await fetch(`${API_BASE_URL}/correct_sentence`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: originalText
                    })
                });

                if (!response.ok) {
                    throw new Error('ë¬¸ì¥ êµì • ìš”ì²­ ì‹¤íŒ¨');
                }

                const result = await response.json();
                console.log('ë¬¸ì¥ êµì • ê²°ê³¼:', result);
                
                if (result && result.success) {
                    // êµì •ëœ ë¬¸ì¥ì„ ì…ë ¥ì°½ì— ì„¤ì •
                    document.getElementById('answerInput').value = result.corrected_text;
                    
                    // êµì • ì—¬ë¶€ì— ë”°ë¥¸ ìƒíƒœ ë©”ì‹œì§€
                    if (result.has_changes) {
                        updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ë° ë¬¸ì¥ êµì • ì™„ë£Œ!');
                    } else {
                        updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! (ë¬¸ì¥ì´ ì´ë¯¸ ì •í™•í•¨)');
                    }
                    
                    // êµì • ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ê¸°
                    showCorrectionResult(originalText, result.corrected_text);
                    
                    // ë””ë²„ê¹… ì •ë³´ ì¶œë ¥
                    if (result.ai_response) {
                        console.log('AI ì›ë³¸ ì‘ë‹µ:', result.ai_response);
                    }
                    if (result.error) {
                        console.log('êµì • ì˜¤ë¥˜:', result.error);
                    }
                } else {
                    updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! (ë¬¸ì¥ êµì • ì‹¤íŒ¨)');
                }
            } catch (error) {
                console.error('ë¬¸ì¥ êµì • ì˜¤ë¥˜:', error);
                updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! (ë¬¸ì¥ êµì • ì‹¤íŒ¨)');
            }
        }

        // ì›ë³¸ STT í…ìŠ¤íŠ¸ ì €ì¥ ë³€ìˆ˜
        let originalSTTText = '';

        // êµì • ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showCorrectionResult(original, corrected) {
            originalSTTText = original; // ì›ë³¸ í…ìŠ¤íŠ¸ ì €ì¥
            const hasChanges = original !== corrected;
            const modal = document.createElement('div');
            modal.id = 'correctionModal';
            modal.className = 'correction-modal';
            modal.innerHTML = `
                <div class="correction-modal-content" style="background: white; border: 2px solid #007bff; border-radius: 12px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="color: #007bff; margin-bottom: 1rem;">
                        ğŸ”§ ë¬¸ì¥ êµì • ë° í¸ì§‘
                    </h3>
                    <p style="color: #666; margin-bottom: 1rem; font-size: 0.9em;">
                        ìŒì„± ì¸ì‹ ê²°ê³¼ë¥¼ êµì •í–ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    
                    <div style="margin: 1rem 0;">
                        <div style="background: #f8f9fa; padding: 0.8rem; border-radius: 6px; margin-bottom: 0.5rem; border-left: 4px solid #6c757d;">
                            <strong style="color: #495057;">ì›ë³¸:</strong> 
                            <span style="color: #6c757d;">${original}</span>
                        </div>
                        <div style="background: ${hasChanges ? '#fff3cd' : '#d1ecf1'}; padding: 0.8rem; border-radius: 6px; border-left: 4px solid ${hasChanges ? '#ffc107' : '#17a2b8'}; margin-bottom: 1rem;">
                            <strong style="color: ${hasChanges ? '#856404' : '#0c5460'};">
                                ${hasChanges ? 'êµì •:' : 'í™•ì¸:'}
                            </strong> 
                            <span style="color: ${hasChanges ? '#856404' : '#0c5460'};">
                                ${corrected}
                            </span>
                        </div>
                        
                        <div style="margin: 1rem 0;">
                            <label style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #333;">í¸ì§‘ (í•„ìš”ì‹œ ìˆ˜ì •):</label>
                            <textarea id="correctionTextarea" style="width: 100%; min-height: 80px; padding: 0.8rem; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical; font-family: inherit;" placeholder="ì—¬ê¸°ì„œ ì§ì ‘ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤...">${corrected}</textarea>
                        </div>
                    </div>
                    
                    <div style="margin: 1rem 0; display: flex; gap: 0.5rem; justify-content: flex-end; flex-wrap: wrap;">
                        <button onclick="rejectCorrection()" style="padding: 0.7rem 1rem; border-radius: 8px; border: 1px solid #ddd; background: white; color: #666; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            ì›ë³¸ ìœ ì§€
                        </button>
                        <button onclick="acceptCorrection()" style="padding: 0.7rem 1rem; border-radius: 8px; border: none; background: #28a745; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            êµì • ì ìš©
                        </button>
                        <button onclick="applyManualEdit()" style="padding: 0.7rem 1rem; border-radius: 8px; border: none; background: #007bff; color: white; cursor: pointer; font-weight: bold; transition: all 0.3s ease;">
                            í¸ì§‘ ì ìš©
                        </button>
                    </div>
                </div>
            `;
            
            Object.assign(modal.style, {
                position: 'fixed',
                left: 0,
                top: 0,
                width: '100vw',
                height: '100vh',
                background: 'rgba(0,0,0,0.5)',
                zIndex: 10000,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center'
            });
            
            document.body.appendChild(modal);
        }

        // êµì • ì ìš© í•¨ìˆ˜
        function acceptCorrection() {
            const modal = document.getElementById('correctionModal');
            const editedText = document.getElementById('correctionTextarea').value;
            document.getElementById('answerInput').value = editedText;
            if (modal) {
                modal.remove();
            }
            updateSTTStatus('âœ… êµì •ëœ ë¬¸ì¥ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // êµì • ê±°ë¶€ í•¨ìˆ˜
        function rejectCorrection() {
            const modal = document.getElementById('correctionModal');
            if (modal) {
                modal.remove();
            }
            // ì›ë³¸ í…ìŠ¤íŠ¸ë¡œ ë˜ëŒë¦¬ê¸°
            document.getElementById('answerInput').value = originalSTTText;
            updateSTTStatus('âœ… ì›ë³¸ ë¬¸ì¥ì´ ìœ ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ìˆ˜ë™ í¸ì§‘ ì ìš© í•¨ìˆ˜
        function applyManualEdit() {
            const modal = document.getElementById('correctionModal');
            const editedText = document.getElementById('correctionTextarea').value;
            document.getElementById('answerInput').value = editedText;
            if (modal) {
                modal.remove();
            }
            updateSTTStatus('âœ… ìˆ˜ë™ í¸ì§‘ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // í–¥ìƒëœ STT ê¸°ëŠ¥ ì‚¬ìš© ì—¬ë¶€ (ê¸°ë³¸ê°’ì„ ê°œì„ ëœ ëª¨ë“œë¡œ ì„¤ì •)
        let useEnhancedSTT = true;

        // STT ê¸°ëŠ¥ í–¥ìƒ ì„¤ì • í† ê¸€
        function toggleEnhancedSTT() {
            useEnhancedSTT = !useEnhancedSTT;
            const status = useEnhancedSTT ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
            updateSTTStatus(`í–¥ìƒëœ STT ê¸°ëŠ¥ì´ ${status}ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const button = document.getElementById('enhancedSTTButton');
            const icon = document.getElementById('enhancedSTTIcon');
            const label = document.getElementById('enhancedSTTLabel');
            
            if (useEnhancedSTT) {
                button.classList.add('active');
                icon.textContent = 'âš¡';
                label.textContent = 'ê°œì„ ëœ';
                icon.title = 'í–¥ìƒëœ STT ê¸°ëŠ¥ í™œì„±í™”ë¨';
            } else {
                button.classList.remove('active');
                icon.textContent = 'ğŸ”§';
                label.textContent = 'ê¸°ë³¸';
                icon.title = 'í–¥ìƒëœ STT ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨';
            }
            
            // ìƒíƒœë¥¼ ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
            sessionStorage.setItem('useEnhancedSTT', useEnhancedSTT.toString());
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ í–¥ìƒëœ STT ì„¤ì • ë³µì› (ê¸°ë³¸ê°’ì„ ê°œì„ ëœ ëª¨ë“œë¡œ ì„¤ì •)
        document.addEventListener('DOMContentLoaded', function() {
            const savedSetting = sessionStorage.getItem('useEnhancedSTT');
            if (savedSetting !== null) {
                useEnhancedSTT = savedSetting === 'true';
            } else {
                // ì €ì¥ëœ ì„¤ì •ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ì ìœ¼ë¡œ ê°œì„ ëœ ëª¨ë“œ ì‚¬ìš©
                useEnhancedSTT = true;
                sessionStorage.setItem('useEnhancedSTT', 'true');
            }
            
            // ë²„íŠ¼ ìƒíƒœ ë³µì› (í† ê¸€ ë²„íŠ¼ì´ ì£¼ì„ì²˜ë¦¬ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ì œê±°)
            /*
            const button = document.getElementById('enhancedSTTButton');
            const icon = document.getElementById('enhancedSTTIcon');
            const label = document.getElementById('enhancedSTTLabel');
            
            if (useEnhancedSTT) {
                button.classList.add('active');
                icon.textContent = 'âš¡';
                label.textContent = 'ê°œì„ ëœ';
                icon.title = 'í–¥ìƒëœ STT ê¸°ëŠ¥ í™œì„±í™”ë¨';
            } else {
                button.classList.remove('active');
                icon.textContent = 'ğŸ”§';
                label.textContent = 'ê¸°ë³¸';
                icon.title = 'í–¥ìƒëœ STT ê¸°ëŠ¥ ë¹„í™œì„±í™”ë¨';
            }
            */
        });

        async function sendAudioToServer(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'recording.wav');
            formData.append('language', 'ko-KR');  // í•œêµ­ì–´ë¡œ ê³ ì •

            try {
                updateSTTStatus('ğŸ”„ ì„œë²„ë¡œ ìŒì„± ì „ì†¡ ì¤‘...');
                console.log('ìŒì„± ë°ì´í„° í¬ê¸°:', audioBlob.size, 'bytes');
                
                // í–¥ìƒëœ STT ì‚¬ìš© ì—¬ë¶€ì— ë”°ë¼ ì—”ë“œí¬ì¸íŠ¸ ì„ íƒ
                const endpoint = useEnhancedSTT ? '/stt_enhanced' : '/stt';
                console.log(`ì‚¬ìš©í•  STT ì—”ë“œí¬ì¸íŠ¸: ${endpoint}`);
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    body: formData
                });

                console.log('ì„œë²„ ì‘ë‹µ ìƒíƒœ:', response.status);
                console.log('ì„œë²„ ì‘ë‹µ í—¤ë”:', response.headers);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('ì„œë²„ ì˜¤ë¥˜ ì‘ë‹µ:', errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const result = await response.json();
                console.log('STT ê²°ê³¼:', result);
                
                if (result && result.text) {
                    // STT ê²°ê³¼ë¥¼ ì…ë ¥ì°½ì— ì„¤ì •
                    document.getElementById('answerInput').value = result.text;
                    
                    // í–¥ìƒëœ STT ê²°ê³¼ ì²˜ë¦¬
                    if (useEnhancedSTT && result.confidence !== undefined) {
                        const confidencePercent = Math.round(result.confidence * 100);
                        updateSTTStatus(`âœ… í–¥ìƒëœ ìŒì„±ì¸ì‹ ì™„ë£Œ! (ì‹ ë¢°ë„: ${confidencePercent}%)`);
                        
                        // í’ˆì§ˆ ì œì•ˆ í‘œì‹œ
                        if (result.suggestions && result.suggestions.length > 0) {
                            showQualitySuggestions(result.suggestions);
                        }
                    } else {
                        updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! ë¬¸ì¥ì„ êµì •í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
                    }
                    
                    // ë¬¸ì¥ êµì • ê¸°ëŠ¥ í˜¸ì¶œ (í–¥ìƒëœ êµì • ì‚¬ìš©)
                    await correctSentenceEnhanced(result.text);
                } else {
                    throw new Error('ìŒì„± ì¸ì‹ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('STT Error:', error);
                updateSTTStatus('âŒ ìŒì„±ì¸ì‹ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // í–¥ìƒëœ ë¬¸ì¥ êµì • í•¨ìˆ˜
        async function correctSentenceEnhanced(text) {
            try {
                // í–¥ìƒëœ êµì • ì‚¬ìš© ì—¬ë¶€ì— ë”°ë¼ ì—”ë“œí¬ì¸íŠ¸ ì„ íƒ
                const endpoint = useEnhancedSTT ? '/correct_sentence_enhanced' : '/correct_sentence';
                console.log(`ì‚¬ìš©í•  êµì • ì—”ë“œí¬ì¸íŠ¸: ${endpoint}`);
                
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (!response.ok) {
                    throw new Error('ë¬¸ì¥ êµì • ìš”ì²­ ì‹¤íŒ¨');
                }

                const result = await response.json();
                console.log('ë¬¸ì¥ êµì • ê²°ê³¼:', result);
                
                if (result && result.success) {
                    // êµì •ëœ ë¬¸ì¥ì„ ì…ë ¥ì°½ì— ì„¤ì •
                    document.getElementById('answerInput').value = result.corrected_text;
                    
                    // í–¥ìƒëœ êµì • ê²°ê³¼ ì²˜ë¦¬
                    if (useEnhancedSTT && result.method_used) {
                        const methodName = result.method_used === 'enhanced' ? 'í–¥ìƒëœ êµì •' : 'AI êµì •';
                        updateSTTStatus(`âœ… ${methodName} ì™„ë£Œ!`);
                        
                        // êµì • ë°©ë²• í‘œì‹œ
                        if (result.corrections_made && result.corrections_made.length > 0) {
                            showCorrectionDetails(result.corrections_made);
                        }
                    } else {
                        updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ë° ë¬¸ì¥ êµì • ì™„ë£Œ!');
                    }
                    
                    // êµì • ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ë³´ì—¬ì£¼ê¸°
                    showCorrectionResult(text, result.corrected_text);
                    
                } else {
                    updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! (ë¬¸ì¥ êµì • ì‹¤íŒ¨)');
                }
            } catch (error) {
                console.error('ë¬¸ì¥ êµì • ì˜¤ë¥˜:', error);
                updateSTTStatus('âœ… ìŒì„±ì¸ì‹ ì™„ë£Œ! (ë¬¸ì¥ êµì • ì‹¤íŒ¨)');
            }
        }



        // í’ˆì§ˆ ì œì•ˆ í‘œì‹œ
        function showQualitySuggestions(suggestions) {
            const suggestionText = suggestions.join('\nâ€¢ ');
            updateSTTStatus(`ğŸ’¡ ì œì•ˆ: ${suggestionText}`);
        }

        // êµì • ì„¸ë¶€ì‚¬í•­ í‘œì‹œ
        function showCorrectionDetails(corrections) {
            const detailsText = corrections.join(', ');
            console.log(`êµì • ì„¸ë¶€ì‚¬í•­: ${detailsText}`);
        }

        // TTS ê¸°ëŠ¥
        async function playTTS(text) {
            try {
                const formData = new FormData();
                formData.append('text', text);
                
                const response = await fetch(`${API_BASE_URL}/tts`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const blob = await response.blob();
                const audio = new Audio(URL.createObjectURL(blob));
                audio.play();
            } catch (error) {
                console.error('TTS Error:', error);
                alert('ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ë¶„ì„ ê²°ê³¼ì— TTS ë²„íŠ¼ ì¶”ê°€
        function showAnalysisResult(result) {
            const resultGraph = document.getElementById('resultGraph');
            resultGraph.style.display = 'block';
            resultGraph.innerHTML = `
                <div style="margin: 1rem 0;">
                    <strong>ë¶„ì„ ê²°ê³¼:</strong> 
                    <span>${result.score.toFixed(1)}ì </span>
                    <button class="tts-button" onclick="playTTS('ë¶„ì„ ê²°ê³¼ëŠ” ${result.score.toFixed(1)}ì  ì…ë‹ˆë‹¤. ${result.detailed_analysis || ''}')" style="margin-left: 1rem;">
                        ğŸ”Š ë“£ê¸°
                    </button>
                </div>
                ${result.detailed_analysis ? `<div style="margin: 0.5rem 0;">${result.detailed_analysis}</div>` : ''}
                ${result.alternative_response ? `<div style="margin: 0.5rem 0; color: #666;">${result.alternative_response}</div>` : ''}
            `;
        }

        // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
        function formatAnalysisText(text) {
            if (!text || text === 'ìƒì„¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.' || text === 'ë¶„ì„ ê·¼ê±° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.') {
                return text;
            }
            
            // ë¶„ì„ê·¼ê±°ì˜ ê²½ìš° í•µì‹¬ ë¬¸ì¥ë§Œ í•˜ì´ë¼ì´íŠ¸
            if (text.includes('ë¼ëŠ” ì§ˆë¬¸ì€') || text.includes('ë¼ëŠ” í‘œí˜„ì€')) {
                // í•µì‹¬ ë¬¸ì¥ì˜ ëì„ ì°¾ê¸° ìœ„í•œ íŒ¨í„´ë“¤
                const patterns = [
                    /(.*?ë¼ëŠ” *?ê¸°ë°˜ìœ¼ë¡œ í•©ë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ë³´ì…ë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ë“œëŸ¬ë‚©ë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ë“œëŸ¬ëƒ…ë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ë‚´í¬ë˜ì–´ ìˆìŠµë‹ˆë‹¤)/,
                    /(.*?ë¼ëŠ” *?ë°°ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)/,
                ];
                
                for (const pattern of patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        const highlightedPart = match[1];
                        const remainingPart = text.substring(match[1].length);
                        
                        return `<span style="background: linear-gradient(120deg, #ffd54f 0%, #ffecb3 100%); padding: 2px 4px; border-radius: 3px; font-weight: bold; color: #d84315;">${highlightedPart}</span>${remainingPart}`;
                    }
                }
                
                // íŒ¨í„´ì´ ë§¤ì¹˜ë˜ì§€ ì•Šìœ¼ë©´ ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ í•˜ì´ë¼ì´íŠ¸
                const sentences = text.split(/[.!?]/).filter(sentence => sentence.trim());
                if (sentences.length > 0) {
                    const firstSentence = sentences[0].trim();
                    const remainingText = text.substring(firstSentence.length);
                    
                    return `<span style="background: linear-gradient(120deg, #ffd54f 0%, #ffecb3 100%); padding: 2px 4px; border-radius: 3px; font-weight: bold; color: #d84315;">${firstSentence}</span>${remainingText}`;
                }
            }
            
            // ê¸°ë³¸ ì²˜ë¦¬: ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ í•˜ì´ë¼ì´íŠ¸
            const sentences = text.split(/[.!?]/).filter(sentence => sentence.trim());
            
            if (sentences.length === 0) {
                return text;
            }
            
            const highlightedText = sentences.map((sentence, index) => {
                const trimmedSentence = sentence.trim();
                if (index === 0 && trimmedSentence) {
                    return `<span style="background: linear-gradient(120deg, #ffd54f 0%, #ffecb3 100%); padding: 2px 4px; border-radius: 3px; font-weight: bold; color: #d84315;">${trimmedSentence}.</span>`;
                } else if (trimmedSentence) {
                    return trimmedSentence + '.';
                }
                return '';
            }).join(' ');
            
            return highlightedText;
        }

        // ìƒì„¸ë¶„ì„ ëª¨ë‹¬ í•¨ìˆ˜ (ver02ì—ì„œ ê°€ì ¸ì˜¨ ê°„ë‹¨í•˜ê³  ê¹”ë”í•œ ë²„ì „)
        async function showDetailAnalysis() {
            console.log('ğŸ” ìƒì„¸ë¶„ì„ ëª¨ë‹¬ í˜¸ì¶œë¨');
            console.log('ğŸ“Š lastResultData:', lastResultData);
            
            if (!lastResultData) {
                console.error('âŒ lastResultDataê°€ ì—†ìŠµë‹ˆë‹¤');
                alert('ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë‹µë³€ì„ ì œì¶œí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ìƒì„¸ë¶„ì„ ëª¨ë‹¬ ë‚´ìš© ìƒì„± (ver02 ìŠ¤íƒ€ì¼)
            const modal = document.createElement('div');
            modal.className = 'detail-modal';
            modal.innerHTML = `
                <div class="detail-modal-content" style="background:#fff; border-radius:16px; max-width:600px; max-height:80vh; margin:50px auto; padding:2em; box-shadow:0 4px 32px rgba(0,0,0,0.18); position:relative; overflow-y:auto; overflow-x:hidden;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 6px; margin-bottom: 1rem; text-align: center; font-size: 0.9em; font-weight: bold;">
                        ğŸ“Š ë¶„ì„ ê²°ê³¼ ìƒì„¸ë³´ê¸°
                    </div>
                    
                    <h4 style="margin-bottom:0.7em; font-family: 'HeirofBold';">ğŸ“‹ ìƒì„¸ ë¶„ì„</h4>
                    <div style="background: #e3f2fd; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #2196f3; font-family: 'HeirofLight';">
                        ${formatAnalysisText(lastResultData.detailed_analysis || 'ìƒì„¸ ë¶„ì„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')}
                    </div>
                    
                    <h4 style="margin-bottom:0.7em; font-family: 'HeirofBold';">ğŸ” ë¶„ì„ ê·¼ê±°</h4>
                    <div style="background: #fff8e1; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #ff9800; font-family: 'HeirofLight';">
                        ${formatAnalysisText(lastResultData.reasoning || 'ë¶„ì„ ê·¼ê±° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.')}
                    </div>
                    
                    <h4 style="margin-bottom:0.7em; font-family: 'HeirofBold';">ğŸ’¡ ê°œì„  ì œì•ˆ</h4>
                    <div style="background: #e8f5e8; padding: 0.8rem; border-radius: 6px; margin-bottom: 1rem; border-left: 4px solid #4caf50; font-family: 'HeirofLight';">
                        ${(lastResultData.suggestions || []).map(suggestion => `<div style="margin-bottom: 0.5rem;">â€¢ ${suggestion}</div>`).join('')}
                    </div>
                    
                    <button onclick="closeDetailModal()" style="margin-top:1em; padding:0.5em 1.5em; border-radius:8px; border:none; background:#1976D2; color:#fff; cursor:pointer; font-family: 'HeirofLight';">ë‹«ê¸°</button>
                </div>
            `;
            
            Object.assign(modal.style, {
                position: 'fixed', left: 0, top: 0, width: '100vw', height: '100vh', background: 'rgba(0,0,0,0.35)', zIndex: 9999, display: 'flex', alignItems: 'center', justifyContent: 'center'
            });
            modal.onclick = function(e) { if (e.target === modal) closeDetailModal(); };
            document.body.appendChild(modal);
            console.log('âœ… ëª¨ë‹¬ ìƒì„± ë° ì¶”ê°€ ì™„ë£Œ');
        }
        function closeDetailModal() {
            const modal = document.querySelector('.detail-modal');
            if (modal) modal.remove();
        }

        // í™ˆìœ¼ë¡œ ê°€ê¸° í•¨ìˆ˜
        function goHome() {
            window.location.href = '/';
        }

        // ê¸°ì¡´ loadingMessage show/hide ë¶€ë¶„ì„ loadingModalë¡œ ë³€ê²½
        function showLoadingModal() {
            document.getElementById('loadingModal').style.display = 'flex';
            startLoadingDots();
        }
        function hideLoadingModal() {
            document.getElementById('loadingModal').style.display = 'none';
            stopLoadingDots();
        }

        // ëª¨ë°”ì¼ ìµœì í™”: í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.addEventListener('DOMContentLoaded', function() {
            const answerInput = document.getElementById('answerInput');
            if (answerInput) {
                // ëª¨ë°”ì¼ì—ì„œ í‚¤ë³´ë“œ ì™„ë£Œ ë²„íŠ¼ ì²˜ë¦¬
                answerInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitAnswer();
                    }
                });
                
                // ëª¨ë°”ì¼ì—ì„œ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ì‹œ ìë™ ìŠ¤í¬ë¡¤
                answerInput.addEventListener('focus', function() {
                    setTimeout(() => {
                        answerInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            }
            
            // ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜ ì´ë²¤íŠ¸ ìµœì í™”
            const submitButton = document.querySelector('.submit-button');
            if (submitButton) {
                submitButton.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(0.95)';
                });
                
                submitButton.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.style.transform = 'scale(1)';
                    submitAnswer();
                });
            }
        });
    </script>
</body>
</html> 